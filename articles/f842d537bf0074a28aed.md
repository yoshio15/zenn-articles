---
title: "MockMvc ã§å­˜åœ¨ã—ãªã„ãƒ‘ã‚¹ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ¥ãŸã¨ãã®ãƒ†ã‚¹ãƒˆã‚’ã™ã‚‹æ–¹æ³•"
emoji: "ğŸ§—ğŸ»"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Java", "SpringBoot", "JUnit"]
published: true
---
## ã¯ã˜ã‚ã«
Controllerã‚¯ãƒ©ã‚¹ã®ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã„ã‚‹æ™‚ã«ã€ã€Œå­˜åœ¨ã—ãªã„ãƒ‘ã‚¹ã€ã«å¯¾ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ¥ãŸã¨ãã®ã‚±ãƒ¼ã‚¹ã‚’æ›¸ã“ã†ã¨æ€ã£ãŸã‚‰ã€æƒ³å®šã‚ˆã‚Šã‚‚é›£ã—ã‹ã£ãŸã®ã§å‚™å¿˜ã®æ„å‘³ã‚’è¾¼ã‚ã¦è¨˜äº‹ã«ã—ã¦ã¿ã¾ã—ãŸã€‚

#### å‹•ä½œç¢ºèªã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³
- Java 11
- Spring Boot 2.3.5.RELEASE
- JUnit 5.x

## ã‚„ã‚ŠãŸã„ã“ã¨
- å­˜åœ¨ã—ãªã„ãƒ‘ã‚¹ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ¥ãŸæ™‚ã«ä»¥ä¸‹ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ãã‚‹ã‹ã‚’ MockMvc ã‚’ä½¿ã£ã¦ãƒ†ã‚¹ãƒˆã—ãŸã„

### ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æœŸå¾…å€¤
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ = `404`
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ = `{"code":"400-001", "message":"wrong url"}`

## ãƒã‚¤ãƒ³ãƒˆ
`MockMvcBuilders.standaloneSetup()` ã‚’ä½¿ã£ã¦ MockMvc ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹æ™‚ã« `addDispatcherServletCustomizer()` ã‚’ä½¿ã£ã¦ã€ãƒ†ã‚¹ãƒˆç”¨ã® `DispatcherServlet` ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¦ãŠãã“ã¨ã€‚  

â€» ãã†ã§ãªã„ã¨ã€å®Ÿéš›ã«ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦å­˜åœ¨ã—ãªã„ãƒ‘ã‚¹ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã£ã¦ã‚‚ `NoHandlerFoundException` ãŒç™ºç”Ÿã›ãšã€æœŸå¾…é€šã‚Šã®çµæœãŒãˆã‚‰ã‚Œãªã„ãŸã‚ã€‚
â€» è©³ã—ã„ã‚½ãƒ¼ã‚¹ã¯ä»¥ä¸‹ã«æ²è¼‰ã—ã¦ã‚ã‚Šã¾ã™ã€‚

## è©³ç´°
ä»Šå›é–¢ä¿‚ã™ã‚‹ã®ã¯ä»¥ä¸‹ã®4ã¤ã®ã‚¯ãƒ©ã‚¹ã§ã™ã€‚

- SampleController.java : ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®Controllerã‚¯ãƒ©ã‚¹
- SampleControllerTest.java : ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹
- CommonControllerAdvice.java : Controllerã®å…±é€šã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
- CustomDispatcherServletCustomizer.java : ã€ãƒã‚¤ãƒ³ãƒˆã€‘ãƒ†ã‚¹ãƒˆç”¨ã® `DispatcherServlet` ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ã‚¯ãƒ©ã‚¹

å…·ä½“çš„ãªã‚½ãƒ¼ã‚¹ã‚’1ã¤ãšã¤ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚

### SampleController.java
ã¾ãšã¯ãƒ†ã‚¹ãƒˆå¯¾è±¡ã¨ãªã‚‹Controllerã‚¯ãƒ©ã‚¹ã§ã™ã€‚ä»Šå›ã¯ `/post` ã«å¯¾ã™ã‚‹POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã‚‹Controllerã‚’1ã¤ä½œæˆã—ã¦ã‚ã‚Šã¾ã™ã€‚

â–  SampleController.java
```java
@RestController
@RequiredArgsConstructor
public class SampleController {

  private final sampleService sampleService;

  // ã€Œ/postã€ ã«å¯¾ã™ã‚‹ POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã‚‹
  @PostMapping("post")
  public XxxResponseForm postXxx(@RequestBody @Valid XxxRequestForm xxxRequestForm) {
    return sampleService.post(xxxRequestForm);
  }

}
```

### CommonControllerAdvice.java

æ¬¡ã«Controllerã‚¯ãƒ©ã‚¹å…±é€šã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã§ã™ã€‚`@RestControllerAdvice` ã®ã¤ã„ãŸã‚¯ãƒ©ã‚¹ã§ã€å„Controllerã§ç™ºç”Ÿã—ãŸä¾‹å¤–ã‚’ä¾‹å¤–ã‚¯ãƒ©ã‚¹åˆ¥ã«æ•æ‰ã—ã¦ã€å…±é€šå‡¦ç†ã‚’æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚

ä»Šå›ã¯ã€å­˜åœ¨ã—ãªã„ãƒ‘ã‚¹ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ¥ãŸæ™‚ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’è¡Œã†ã“ã¨ãŒç›®çš„ãªã®ã§ã€ `NoHandlerFoundException` ã®ç™ºç”Ÿã‚’ã“ã“ã§å¾…ã¡å—ã‘ã¾ã™ã€‚

ãªãŠã€Springã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è¨­å®šã§ã¯ã€å­˜åœ¨ã—ãªã„ãƒ‘ã‚¹ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ `NoHandlerFoundException` ã¯ç™ºç”Ÿã—ãªã„ãŸã‚ã€ `application.yml` (è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«)ã«ã¦æ¬¡ã®ã‚ˆã†ã«è¨­å®šã—ã¦ãŠãã¾ã™ã€‚
```
spring:
  mvc:
    throw-exception-if-no-handler-found: true
```
ã“ã®è¨­å®šã«ã‚ˆã£ã¦ã€å­˜åœ¨ã—ãªã„ãƒ‘ã‚¹ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ¥ãŸå ´åˆã« `NoHandlerFoundException` ãŒã‚¹ãƒ­ãƒ¼ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚(â€»[å‚è€ƒ](https://spring.pleiades.io/spring-boot/docs/current/reference/html/appendix-application-properties.html#spring.mvc.throw-exception-if-no-handler-found))

å®Ÿéš›ã«ã€`NoHandlerFoundException` ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯400ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã«ã€
```
{ "code": "400-001", "message": "wrong url" }
```
ãŒè¿”å´ã•ã‚Œã‚‹ã‚ˆã†ã«çµ„ã‚“ã§ã„ã¾ã™ã€‚

â–  CommonControllerAdvice.java
```java
@RestControllerAdvice
public class CommonControllerAdvice {

  // ... ç•¥ ...

  // NoHandlerFoundException ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã§ãƒãƒ³ãƒ‰ãƒ«ã•ã‚Œã€
  // ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ãŸ ResponsBody ã¨ HttpStatus.BAD_REQUEST(status=400) ã‚’è¿”å´ã™ã‚‹
  @ExceptionHandler(NoHandlerFoundException.class)
  public ResponseEntity<xxxErrorResponse> handleNoHandlerFoundException(
      NoHandlerFoundException ex) {
    return new ResponseEntity<>(xxxErrorResponse.create("400-001",
        "wrong url"), HttpStatus.BAD_REQUEST);
  }

  // ... ç•¥ ...

}
```

### SampleControllerTest.java

æ¬¡ãŒControllerç”¨ã®ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã§ã™ã€‚Controllerã‚¯ãƒ©ã‚¹ã®ãƒ†ã‚¹ãƒˆã«ã¯ MockMvc ãŒä¾¿åˆ©ã¨ã„ã†ã“ã¨ã§ã€ä¾‹ã«æ¼ã‚Œãš MockMvc ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚
ï¼ˆControllerã‚¯ãƒ©ã‚¹ã®ãƒ†ã‚¹ãƒˆã®æ›¸ãæ–¹ã«ã¤ã„ã¦ã¯ã€[ã‚³ãƒãƒ©](https://qiita.com/ryo2132/items/ec10116238e1e1f333a1)ã®è¨˜äº‹ãŒå‚è€ƒã«ãªã‚Šã¾ã™ã€‚ï¼‰

ã“ã“ã§ãƒã‚¤ãƒ³ãƒˆã¨ãªã‚‹ã®ãŒã€ `@BeforeEach` ã§ `mockMvc` ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦ã„ã‚‹ç®‡æ‰€ã§ã™ã€‚
`MockMvcBuilders.standaloneSetup()` ã«ã¦ `mockMvc` ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹æ™‚ã«ã€ `addDispatcherServletCustomizer()` ã‚’ä½¿ã£ã¦ã€ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ãŸ `DispatcherServlet` ã‚’ã‚»ãƒƒãƒˆã—ã¾ã™ã€‚

ã“ã“ã§ã€ãªãœ `DispatcherServlet` ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãŒå¿…è¦ãªã®ã‹ã¨ã„ã†ã¨ã€
`MockMvcBuilders.standaloneSetup()` ã«ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã•ã‚ŒãŸå ´åˆã®ãƒ†ã‚¹ãƒˆç”¨ã® `DispatcherServlet` ã¯Springã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã—ã¦ã„ãªã„ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®ï¼‰ãŸã‚(â€»[å‚è€ƒ](https://terasolunaorg.github.io/guideline/5.4.1.RELEASE/ja/UnitTest/ImplementsOfUnitTest/UsageOfLibraryForTest.html#usageoflibraryfortestmockmvcoverview))ã§ã™ã€‚

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®ã¾ã¾ã ã¨ã€ä¸Šè¨˜ã®é€šã‚Šã€å­˜åœ¨ã—ãªã„ãƒ‘ã‚¹ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ `NoHandlerFoundException` ã¯ç™ºç”Ÿã›ãšã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹=404ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£=ç©ºã€ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”å´ã•ã‚Œã€ãƒ†ã‚¹ãƒˆãŒNGã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

APIãƒ„ãƒ¼ãƒ«ã‹ã‚‰å®Ÿéš›ã«å­˜åœ¨ã—ãªã„ãƒ‘ã‚¹ã«å¯¾ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã£ã¦ã¿ã‚‹ã¨ã€æœŸå¾…é€šã‚Šã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯400ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã¯
```
{ "code": "400-001", "message": "wrong url" }
```
ãŒè¿”å´ã•ã‚Œã¾ã™ã€‚

ãªã®ã§ã€æœ¬ãƒã‚¤ãƒ³ãƒˆã‚’çŸ¥ã‚‰ãšã«ã„ã¤ã‚‚é€šã‚Šãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã—ã¾ã†ã¨ã€å®Ÿéš›ã®æŒ™å‹•ã¯å•é¡Œãªã„ã®ã§ã™ãŒã€ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã¿ã‚‹ã¨NGã«ãªã‚‹ã€ã¨ã„ã†å•é¡ŒãŒç™ºç”Ÿã—ã¦ã—ã¾ã„ã¾ã™ã€‚
(ç§ã¯ã“ã“ã§è‹¦åŠ´ã—ã¾ã—ãŸ...ã€‚)

ã¡ãªã¿ã«ãã®æ™‚ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœã¨ã€ `print()` ã§ã®å‡ºåŠ›å†…å®¹ã¯æ¬¡ã®é€šã‚Šã§ã™ã€‚

- å®Ÿè¡Œçµæœ : NG
```
Expected :{"code":"400-001","message":"wrong url"}
Actual   :
```

- `andDo(print())` ã§ã®å‡ºåŠ› : ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹=404ã€ãƒœãƒ‡ã‚£ã¯ç©º
```
MockHttpServletResponse:
           Status = 404
    Error message = null
          Headers = []
     Content type = null
             Body = 
    Forwarded URL = null
   Redirected URL = null
          Cookies = []
```

â–  SampleControllerTest.java
```java
@SpringBootTest
@ExtendWith(SpringExtension.class)
@ActiveProfiles("test")
public class SampleControllerTest {

  @Autowired
  private SampleController sampleController;

  private MockMvc mockMvc;

  @BeforeEach
  public void setup() {
    this.mockMvc =
        MockMvcBuilders.standaloneSetup(sampleController)
            // å…±é€šã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ã‚»ãƒƒãƒˆï¼ˆ @(Rest)ControllerAdvice ãŒä»˜ä¸ã•ã‚Œã¦ã„ã‚‹ã‚¯ãƒ©ã‚¹ ï¼‰
            .setControllerAdvice(new HogeControllerAdvice())
            // â€»â€»â€» ãƒã‚¤ãƒ³ãƒˆ â€»â€»â€»
            // â†“ ã“ã“ã§ DispatcherServletCustomizer ã‚’å®Ÿè£…ã—ãŸã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã‚»ãƒƒãƒˆ
            .addDispatcherServletCustomizer(
              new CustomDispatcherServletCustomizer())
            .build();
  }

  @Test
  @DisplayName("å­˜åœ¨ã—ãªã„ãƒ‘ã‚¹ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ")
  void notExistUrl() throws Exception {
    MockHttpServletRequestBuilder request =
        MockMvcRequestBuilders.post("/hogehoge") // å­˜åœ¨ã—ãªã„ãƒ‘ã‚¹
            .contentType(MediaType.APPLICATION_JSON)
            .content("{\"body\" : \"any\"}");    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£
    mockMvc
        .perform(request)
        .andDo(print())
        .andExpect(status().is4xxClientError())
        .andExpect(content().string(
          "{\"code\":\"400-001\",\"message\":\"wrong url\"}"));
  }

}
```

### CustomDispatcherServletCustomizer.java

ãã—ã¦æœ€å¾Œã®4ã¤ç›®ãŒã€ãƒ†ã‚¹ãƒˆç”¨ã® DispatcherServlet ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ã‚¯ãƒ©ã‚¹ã§ã™ã€‚
ã“ã®ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã€ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã§ MockMvc ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦ã„ã‚‹ç®‡æ‰€ã«ã¦ã€
`.addDispatcherServletCustomizer(new CustomDispatcherServletCustomizer())` ã¨ã„ã†å½¢ã§è¿½åŠ ã—ã¦ã‚ã’ã‚Œã°OKã§ã™ã€‚

ã“ã®ã‚¯ãƒ©ã‚¹ã®ãƒã‚¤ãƒ³ãƒˆã¯2ã¤ã‚ã‚Šã¾ã™ã€‚
- `DispatcherServletCustomizer` ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨
- `setThrowExceptionIfNoHandlerFound(true)` ã§ `NoHandlerFoundException` ã‚’ç™ºç”Ÿã™ã‚‹ã‚ˆã†ã«è¨­å®šã™ã‚‹ã“ã¨

â–  CustomDispatcherServletCustomizer.java
```java
// ãƒ†ã‚¹ãƒˆç”¨ã® DispatcherServlet ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ã‚¯ãƒ©ã‚¹
// DispatcherServletCustmizer ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…(implements)ã™ã‚‹
public class CustomDispatcherServletCustomizer implements DispatcherServletCustomizer {

  @Override
  public void customize(DispatcherServlet dispatcherServlet) {
    // application.yml ã® spring.mvc.throw-exception-if-no-handler-found ã‚’ trueã«ã‚»ãƒƒãƒˆ.
    dispatcherServlet.setThrowExceptionIfNoHandlerFound(true);
  }
}
```

ã“ã“ã¾ã§è¨­å®šã™ã‚Œã°æº–å‚™OKã§ã™ã€‚ã‚ã¨ã¯å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚


## çµæœ
ä»¥ä¸‹ã®é€šã‚Šãƒ†ã‚¹ãƒˆOKã¨ãªã‚Šã¾ã—ãŸã€‚

### å®Ÿè¡Œçµæœ
```
SampleControllerTest > å­˜åœ¨ã—ãªã„ãƒ‘ã‚¹ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ PASSED
``` 
### `andDo(print())` ã«ã‚ˆã‚‹å‡ºåŠ›
```
MockHttpServletResponse:
           Status = 400
    Error message = null
          Headers = [Content-Type:"application/json"]
     Content type = application/json
             Body = {"code":"400-001","message":"wrong url"}
    Forwarded URL = null
   Redirected URL = null
          Cookies = []
```
ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹400ã§ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã«ã‚‚æœŸå¾…é€šã‚Šã®å€¤ãŒè¿”ã£ã¦ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

## å‚è€ƒè³‡æ–™
- https://terasolunaorg.github.io/guideline/5.4.1.RELEASE/ja/UnitTest/ImplementsOfUnitTest/UsageOfLibraryForTest.html#usageoflibraryfortestmockmvcoverview
- https://github.com/spring-projects/spring-framework/issues/18849
    - https://github.com/spring-projects/spring-framework/commit/1e3012cb49c9446056e7151d52cabdc36292ec61
- https://spring.pleiades.io/spring-boot/docs/current/reference/html/appendix-application-properties.html#spring.mvc.throw-exception-if-no-handler-found
- https://qiita.com/ryo2132/items/ec10116238e1e1f333a1